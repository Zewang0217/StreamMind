<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预警详情分析</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #495057;
            display: flex;
            align-items: center;
        }
        
        .chart-title i {
            margin-right: 0.5rem;
        }
        
        .filter-panel {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            color: white;
        }
        
        .score-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .score-high {
            background-color: #dc3545;
            color: white;
        }
        
        .score-medium {
            background-color: #ffc107;
            color: #212529;
        }
        
        .score-low {
            background-color: #28a745;
            color: white;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .breadcrumb-item a {
            color: #667eea;
            text-decoration: none;
        }
        
        .breadcrumb-item a:hover {
            color: #764ba2;
        }
    </style>
</head>
<body>
    <!-- 加载遮罩 -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">加载中...</span>
            </div>
            <h4 class="mt-3 text-primary">正在加载数据...</h4>
        </div>
    </div>

    <!-- 页面头部 -->
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-0">
                        <i class="fas fa-microscope me-3"></i>
                        预警详情分析
                    </h2>
                    <nav aria-label="breadcrumb" class="mt-2">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/">仪表盘</a></li>
                            <li class="breadcrumb-item active text-white">详情分析</li>
                        </ol>
                    </nav>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light" id="refresh-btn">
                        <i class="fas fa-sync-alt me-2"></i>刷新数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- 筛选面板 -->
        <div class="filter-panel">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <label for="time-range" class="form-label">时间范围</label>
                    <select class="form-select" id="time-range">
                        <option value="1">过去1小时</option>
                        <option value="6">过去6小时</option>
                        <option value="12">过去12小时</option>
                        <option value="24" selected>过去24小时</option>
                        <option value="168">过去7天</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="topic-filter" class="form-label">话题来源</label>
                    <select class="form-select" id="topic-filter">
                        <option value="">全部话题</option>
                        <option value="weibo">微博</option>
                        <option value="zhihu">知乎</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="risk-filter" class="form-label">风险等级</label>
                    <select class="form-select" id="risk-filter">
                        <option value="">全部等级</option>
                        <option value="high">高风险</option>
                        <option value="medium">中风险</option>
                        <option value="low">低风险</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-gradient w-100" id="apply-filters">
                        <i class="fas fa-filter me-2"></i>应用筛选
                    </button>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="row">
            <!-- 预警趋势对比图 -->
            <div class="col-lg-8">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-line"></i>
                        预警趋势对比分析
                    </div>
                    <div id="trend-comparison-chart" style="height: 400px;"></div>
                </div>
            </div>
            
            <!-- 风险评分分布 -->
            <div class="col-lg-4">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-area"></i>
                        风险评分分布
                    </div>
                    <div id="score-distribution-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 话题风险对比 -->
            <div class="col-lg-6">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-balance-scale"></i>
                        话题风险对比
                    </div>
                    <div id="topic-risk-chart" style="height: 350px;"></div>
                </div>
            </div>
            
            <!-- 时间热力图 -->
            <div class="col-lg-6">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-fire"></i>
                        预警时间热力图
                    </div>
                    <div id="time-heatmap-chart" style="height: 350px;"></div>
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="data-table">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    预警详情数据
                </h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-2" id="export-csv">
                        <i class="fas fa-download me-1"></i>导出CSV
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="toggle-columns">
                        <i class="fas fa-cog me-1"></i>显示列
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover" id="alerts-table">
                    <thead class="table-dark">
                        <tr>
                            <th>时间</th>
                            <th>来源</th>
                            <th>用户ID</th>
                            <th>内容</th>
                            <th>风险分数</th>
                            <th>毒性分数</th>
                            <th>话题</th>
                        </tr>
                    </thead>
                    <tbody id="alerts-tbody">
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <nav aria-label="数据分页" class="mt-3">
                <ul class="pagination justify-content-center" id="pagination">
                </ul>
            </nav>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        class AlertDetailsAnalyzer {
            constructor() {
                this.apiBaseUrl = '/api/dashboard';
                this.charts = {};
                this.currentPage = 1;
                this.pageSize = 20;
                this.filters = {
                    timeRange: 24,
                    topic: '',
                    riskLevel: ''
                };
                this.allData = []; // 存储所有数据用于客户端筛选
                this.init();
            }

            async init() {
                try {
                    await this.loadInitialData();
                    this.initCharts();
                    this.bindEvents();
                    this.hideLoading();
                } catch (error) {
                    console.error('初始化失败:', error);
                    this.showError('数据加载失败，请刷新页面重试');
                }
            }

            async loadInitialData() {
                // 加载24小时的数据作为基础数据
                const alerts = await this.fetchAlertsData(24);
                this.allData = this.processAlertData(alerts);
                this.updateCharts();
                this.updateTable();
            }

            async fetchAlertsData(hours) {
                const endTime = new Date();
                const startTime = new Date(endTime.getTime() - hours * 60 * 60 * 1000);
                
                // 获取统计数据
                const [stats, trends, topics] = await Promise.all([
                    this.fetchData('stats'),
                    this.fetchData(`trends?hours=${hours}`),
                    this.fetchData('topics')
                ]);

                return { stats, trends, topics, timeRange: { start: startTime, end: endTime } };
            }

            async fetchData(endpoint) {
                const response = await fetch(`${this.apiBaseUrl}/${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            }

            processAlertData(data) {
                const { stats, trends, topics } = data;
                
                // 合并微博和知乎的预警数据
                const weiboAlerts = stats.weiboAlerts || [];
                const zhihuAlerts = stats.zhihuAlerts || [];
                
                const allAlerts = [...weiboAlerts, ...zhihuAlerts].map(alert => ({
                    ...alert,
                    source: alert.topic === 'weibo' ? '微博' : '知乎',
                    riskLevel: this.getRiskLevel(alert.negativeScore),
                    timestamp: new Date(alert.createdAt)
                }));

                return {
                    alerts: allAlerts,
                    hourlyStats: trends.hourlyStats || {},
                    weiboHourly: trends.weiboHourly || {},
                    zhihuHourly: trends.zhihuHourly || {},
                    topicDistribution: topics.topicDistribution || {},
                    riskDistribution: topics.riskDistribution || {}
                };
            }

            getRiskLevel(score) {
                if (score > 0.7) return 'high';
                if (score > 0.5) return 'medium';
                return 'low';
            }

            initCharts() {
                // 趋势对比图
                this.charts.trendComparison = echarts.init(document.getElementById('trend-comparison-chart'));
                
                // 评分分布图
                this.charts.scoreDistribution = echarts.init(document.getElementById('score-distribution-chart'));
                
                // 话题风险对比图
                this.charts.topicRisk = echarts.init(document.getElementById('topic-risk-chart'));
                
                // 时间热力图
                this.charts.timeHeatmap = echarts.init(document.getElementById('time-heatmap-chart'));

                // 响应式
                window.addEventListener('resize', () => {
                    Object.values(this.charts).forEach(chart => chart.resize());
                });
            }

            updateCharts() {
                this.updateTrendComparisonChart();
                this.updateScoreDistributionChart();
                this.updateTopicRiskChart();
                this.updateTimeHeatmapChart();
            }

            updateTrendComparisonChart() {
                const hourlyData = this.allData.hourlyStats;
                const weiboData = this.allData.weiboHourly;
                const zhihuData = this.allData.zhihuHourly;
                
                const hours = Object.keys(hourlyData).sort();
                const totalData = hours.map(hour => hourlyData[hour] || 0);
                const weiboValues = hours.map(hour => weiboData[hour] || 0);
                const zhihuValues = hours.map(hour => zhihuData[hour] || 0);

                const formattedHours = hours.map(hour => {
                    const date = new Date(hour);
                    return `${date.getHours().toString().padStart(2, '0')}:00`;
                });

                this.charts.trendComparison.setOption({
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    legend: {
                        data: ['总预警', '微博', '知乎'],
                        top: '5%'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: formattedHours
                    },
                    yAxis: {
                        type: 'value',
                        name: '预警数量'
                    },
                    series: [
                        {
                            name: '总预警',
                            type: 'line',
                            smooth: true,
                            data: totalData,
                            itemStyle: { color: '#667eea' },
                            areaStyle: { opacity: 0.3 }
                        },
                        {
                            name: '微博',
                            type: 'line',
                            smooth: true,
                            data: weiboValues,
                            itemStyle: { color: '#e74c3c' }
                        },
                        {
                            name: '知乎',
                            type: 'line',
                            smooth: true,
                            data: zhihuValues,
                            itemStyle: { color: '#3498db' }
                        }
                    ]
                });
            }

            updateScoreDistributionChart() {
                const alerts = this.getFilteredAlerts();
                
                // 计算分数分布
                const scoreRanges = {
                    '0.0-0.2': 0, '0.2-0.4': 0, '0.4-0.6': 0, 
                    '0.6-0.8': 0, '0.8-1.0': 0
                };
                
                alerts.forEach(alert => {
                    const score = alert.negativeScore || 0;
                    if (score <= 0.2) scoreRanges['0.0-0.2']++;
                    else if (score <= 0.4) scoreRanges['0.2-0.4']++;
                    else if (score <= 0.6) scoreRanges['0.4-0.6']++;
                    else if (score <= 0.8) scoreRanges['0.6-0.8']++;
                    else scoreRanges['0.8-1.0']++;
                });

                this.charts.scoreDistribution.setOption({
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: Object.keys(scoreRanges)
                    },
                    yAxis: {
                        type: 'value',
                        name: '预警数量'
                    },
                    series: [{
                        name: '风险评分分布',
                        type: 'bar',
                        data: Object.values(scoreRanges),
                        itemStyle: {
                            color: function(params) {
                                const colors = ['#28a745', '#20c997', '#ffc107', '#fd7e14', '#dc3545'];
                                return colors[params.dataIndex];
                            }
                        }
                    }]
                });
            }

            updateTopicRiskChart() {
                const alerts = this.getFilteredAlerts();
                
                // 按话题统计风险
                const topicStats = {};
                alerts.forEach(alert => {
                    const topic = alert.source;
                    if (!topicStats[topic]) {
                        topicStats[topic] = { high: 0, medium: 0, low: 0, total: 0 };
                    }
                    topicStats[topic][alert.riskLevel]++;
                    topicStats[topic].total++;
                });

                const topics = Object.keys(topicStats);
                const highData = topics.map(topic => topicStats[topic].high);
                const mediumData = topics.map(topic => topicStats[topic].medium);
                const lowData = topics.map(topic => topicStats[topic].low);

                this.charts.topicRisk.setOption({
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' }
                    },
                    legend: {
                        data: ['高风险', '中风险', '低风险']
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: topics
                    },
                    yAxis: {
                        type: 'value',
                        name: '预警数量'
                    },
                    series: [
                        {
                            name: '高风险',
                            type: 'bar',
                            data: highData,
                            itemStyle: { color: '#dc3545' }
                        },
                        {
                            name: '中风险',
                            type: 'bar',
                            data: mediumData,
                            itemStyle: { color: '#ffc107' }
                        },
                        {
                            name: '低风险',
                            type: 'bar',
                            data: lowData,
                            itemStyle: { color: '#28a745' }
                        }
                    ]
                });
            }

            updateTimeHeatmapChart() {
                const alerts = this.getFilteredAlerts();
                
                // 构建热力图数据（按小时和星期统计）
                const heatmapData = [];
                const hours = Array.from({length: 24}, (_, i) => i);
                const days = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
                
                // 初始化计数器
                const counter = {};
                days.forEach((day, dayIndex) => {
                    counter[dayIndex] = {};
                    hours.forEach(hour => {
                        counter[dayIndex][hour] = 0;
                    });
                });
                
                // 统计每个时间段的数据
                alerts.forEach(alert => {
                    const date = new Date(alert.createdAt);
                    const dayIndex = (date.getDay() + 6) % 7; // 转换为周一开始
                    const hour = date.getHours();
                    counter[dayIndex][hour]++;
                });
                
                // 构建热力图数据格式
                days.forEach((day, dayIndex) => {
                    hours.forEach(hour => {
                        heatmapData.push([hour, dayIndex, counter[dayIndex][hour]]);
                    });
                });

                this.charts.timeHeatmap.setOption({
                    tooltip: {
                        position: 'top',
                        formatter: function(params) {
                            return `${days[params.value[1]]} ${params.value[0]}:00<br/>预警数量: ${params.value[2]}`;
                        }
                    },
                    grid: {
                        height: '80%',
                        top: '10%'
                    },
                    xAxis: {
                        type: 'category',
                        data: hours.map(h => `${h}:00`),
                        splitArea: {
                            show: true
                        }
                    },
                    yAxis: {
                        type: 'category',
                        data: days,
                        splitArea: {
                            show: true
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: Math.max(...heatmapData.map(d => d[2])),
                        calculable: true,
                        orient: 'horizontal',
                        left: 'center',
                        bottom: '5%',
                        inRange: {
                            color: ['#e3f2fd', '#bbdefb', '#90caf9', '#64b5f6', '#42a5f5', '#2196f3', '#1e88e5', '#1976d2', '#1565c0', '#0d47a1']
                        }
                    },
                    series: [{
                        name: '预警热力图',
                        type: 'heatmap',
                        data: heatmapData,
                        label: {
                            show: true
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }]
                });
            }

            updateTable() {
                const alerts = this.getFilteredAlerts();
                const tbody = document.getElementById('alerts-tbody');
                
                if (alerts.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle fa-2x mb-2"></i>
                                <p>暂无符合条件的预警数据</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                const rows = alerts.slice(0, this.pageSize).map(alert => `
                    <tr>
                        <td>${new Date(alert.createdAt).toLocaleString('zh-CN')}</td>
                        <td><i class="${alert.topic === 'weibo' ? 'fab fa-weibo text-danger' : 'fab fa-zhihu text-primary'}"></i> ${alert.source}</td>
                        <td><code>${alert.userId}</code></td>
                        <td>
                            <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                                ${alert.content || '暂无内容'}
                            </div>
                        </td>
                        <td>
                            <span class="score-badge score-${alert.riskLevel}">
                                ${(alert.negativeScore * 100).toFixed(1)}%
                            </span>
                        </td>
                        <td>
                            <span class="score-badge ${alert.toxicScore > 0.5 ? 'score-high' : alert.toxicScore > 0.3 ? 'score-medium' : 'score-low'}">
                                ${((alert.toxicScore || 0) * 100).toFixed(1)}%
                            </span>
                        </td>
                        <td><span class="badge bg-secondary">${alert.topic}</span></td>
                    </tr>
                `).join('');

                tbody.innerHTML = rows;
            }

            getFilteredAlerts() {
                let alerts = this.allData.alerts || [];
                
                // 应用筛选条件
                if (this.filters.topic) {
                    alerts = alerts.filter(alert => alert.topic === this.filters.topic);
                }
                
                if (this.filters.riskLevel) {
                    alerts = alerts.filter(alert => alert.riskLevel === this.filters.riskLevel);
                }
                
                // 时间筛选已经在数据加载时处理
                return alerts;
            }

            bindEvents() {
                // 筛选按钮事件
                document.getElementById('apply-filters').addEventListener('click', () => {
                    this.filters.timeRange = parseInt(document.getElementById('time-range').value);
                    this.filters.topic = document.getElementById('topic-filter').value;
                    this.filters.riskLevel = document.getElementById('risk-filter').value;
                    this.applyFilters();
                });

                // 刷新按钮事件
                document.getElementById('refresh-btn').addEventListener('click', () => {
                    this.refreshData();
                });

                // 导出CSV事件
                document.getElementById('export-csv').addEventListener('click', () => {
                    this.exportToCSV();
                });
            }

            async applyFilters() {
                this.showLoading();
                try {
                    // 重新获取数据
                    const alerts = await this.fetchAlertsData(this.filters.timeRange);
                    this.allData = this.processAlertData(alerts);
                    this.updateCharts();
                    this.updateTable();
                } catch (error) {
                    console.error('应用筛选失败:', error);
                    this.showError('筛选数据失败');
                } finally {
                    this.hideLoading();
                }
            }

            async refreshData() {
                const btn = document.getElementById('refresh-btn');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>刷新中...';
                btn.disabled = true;
                
                try {
                    await this.applyFilters();
                } finally {
                    btn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>刷新数据';
                    btn.disabled = false;
                }
            }

            exportToCSV() {
                const alerts = this.getFilteredAlerts();
                if (alerts.length === 0) {
                    alert('暂无数据可导出');
                    return;
                }

                const headers = ['时间', '来源', '用户ID', '内容', '风险分数', '毒性分数', '话题'];
                const csvContent = [
                    headers.join(','),
                    ...alerts.map(alert => [
                        new Date(alert.createdAt).toLocaleString('zh-CN'),
                        alert.source,
                        alert.userId,
                        `"${(alert.content || '').replace(/"/g, '""')}"`,
                        alert.negativeScore,
                        alert.toxicScore || 0,
                        alert.topic
                    ].join(','))
                ].join('\n');

                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `预警数据_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
            }

            showLoading() {
                document.getElementById('loading-overlay').style.display = 'flex';
            }

            hideLoading() {
                document.getElementById('loading-overlay').style.display = 'none';
            }

            showError(message) {
                alert(message); // 可以替换为更好的错误提示方式
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            new AlertDetailsAnalyzer();
        });
    </script>
</body>
</html>